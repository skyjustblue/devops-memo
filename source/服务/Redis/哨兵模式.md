# 哨兵模式

## 安装redis并搭建主从
需要三台节点以上，一主两从或多从。

## 部署sentinel
**三台机器一样操作步骤**
```
vi  /usr/local/redis/conf/sentinel.conf
# 添加如下内容
protected-mode no
port 26379
daemonize yes
pidfile /usr/local/redis/log/redis-sentinel.pid
logfile "/usr/local/redis/log/redis-sentinel.log"
dir /tmp

##最核心的配置，当集群中有2个sentinel认为master宕机时，才能真正认为该master已经不可用了。mymaster为自定义的集群名字(slave上面写的是master的ip，master写自己ip)
sentinel monitor mymaster 192.168.1.152 6379 2

##若master配置了密码，则需要定义下面配置
sentinel auth-pass mymaster aminglinux.Com

##单位毫秒 3000毫秒没响应，认为主观下线
sentinel down-after-milliseconds mymaster 30000

##定义acl日志有多少条，acl日志存储在内存中，acl日志里记录跟acl相关的失败命令和身份验证事件
acllog-max-len 128

## 当替换主节点后，剩余从节点重新和新master做同步的并行数量，默认为 1
sentinel parallel-syncs mymaster 1

##若sentinel在该配置值(单位毫秒)内未能完成failover(故障转移)操作（即故障时master/slave自动切换），则认为本次failover失败。
sentinel failover-timeout mymaster 180000

## 在sentinel运行期间，不允许通过sentinel set命令重新配置notification-script（告警脚本）和client-reconfig-script（通知客户端，master已经更改成什么ip和port的脚本）
sentinel deny-scripts-reconfig yes

## 是否支持解析主机名
SENTINEL resolve-hostnames no
## 是否保留公开主机名
SENTINEL announce-hostnames no

## 如果设置为0，则当sentinel从master收到一个LoADING响应时，不会做故障转移。单位为毫秒，如果设置为非零，则在该时间段内，sentinel接收到LOADING响应时不做故障转移。
SENTINEL master-reboot-down-after-period mymaster 0



# 更改目录及其配置文件属主
chown -R redis:redis /usr/local/redis/conf
chown -R redis:redis /usr/local/redis/log

# 推送到其他节点
scp /usr/local/redis/conf/sentinel.conf root@192.168.1.156:/usr/local/redis/conf/
scp/usr/local/redis/conf/sentinel.conf root@192.168.1.136:/usr/local/redis/conf/
```
```
# 配置systemd服务启动脚本
vi /lib/systemd/system/redis-sentinel.service

[Unit]
Description=redis
After=network.target
[Service]
User=redis
Type=forking
TimeoutSec=0
PIDFile=/usr/local/redis/log/redis-sentinel.pid
ExecStart=/usr/local/redis/bin/redis-sentinel /usr/local/redis/conf/sentinel.conf
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true
[Install]
WantedBy=multi-user.target

# 推送到其他节点
scp /lib/systemd/system/redis-sentinel.service root@192.168.1.156:/lib/systemd/system/
scp /lib/systemd/system/redis-sentinel.service root@192.168.1.136:/lib/systemd/system/

# 加载、启动服务
systemctl daemon-reload
systemctl start redis-sentinel.service
```
