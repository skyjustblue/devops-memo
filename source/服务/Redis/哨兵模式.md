# 哨兵模式

## 介绍
Redis主从解决了数据备份，但不能实现当主库异常，自动切换到从库，而Redis哨兵解决的问题就是自动切换。  

Sentinel(哨兵)是用于监控redis集群中Master状态的工具，其已经被集成在redis2.4+的版本中，是Redis官方推荐的高可用性(HA)解决方案。

<br>
Redis哨兵作用：

- Master状态检测
- 如果Master异常，则会进行Master-Slave切换，将其中一个Slave作为Master，将之前的Master作为Slave
- Master-Slave切换后，sentinel.conf的监控目标会随之调换

<br>
Redis哨兵工作模式：

1. 每个Sentinel以每秒钟一次的频率向它所知的Master，Slave以及其他 Sentinel 实例发送一个 PING 命令
2. 如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被 Sentinel 标记为主观下线。
3. 如果一个Master被标记为主观下线，则正在监视这个Master的所有 Sentinel 要以每秒一次的频率确认Master的确进入了主观下线状态。
4. 当有足够数量的 Sentinel（大于等于配置文件指定的值）在指定的时间范围内确认Master的确进入了主观下线状态， 则Master会被标记为客观下线 。

<br>
主观下线和客观下线：

- 主观下线：Subjectively Down，简称 SDOWN，指的是当前 一个Sentinel 实例对某个redis服务器做出的下线判断。
- 客观下线：Objectively Down， 简称 ODOWN，指的是多个 Sentinel 实例在对Master Server做出 SDOWN  判断，并且通过 SENTINEL is-master-down-by-addr 命令互相交流之后，得出的Master  Server下线判断，然后开启failover



## 安装redis并搭建主从
[安装redis服务](https://linyi.readthedocs.io/zh/latest/%E6%9C%8D%E5%8A%A1/Redis/%E5%AE%89%E8%A3%85.html)    
[搭建主从](https://linyi.readthedocs.io/zh/latest/%E6%9C%8D%E5%8A%A1/Redis/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.html#)  

**需要三台节点以上，一主两从或一主多从。**  
**sentinel可以独立存在，也可以和redis服务部署在一台机器上** 
> 注：两台slave上，`replica-priority`要配置成不一样，数值越小，优先级越高。如果数值一样则随机选主。   
>     master上也需要设置`replica-priority`，因为当当前master挂掉后恢复会变为slave。

## 部署sentinel
**三台机器一样操作**
```
vi  /usr/local/redis/conf/sentinel.conf
# 添加如下内容
protected-mode no
port 26379
daemonize yes
pidfile /usr/local/redis/log/redis-sentinel.pid
logfile "/usr/local/redis/log/redis-sentinel.log"
dir /tmp

##最核心的配置，当集群中有2个sentinel认为master宕机时，才能真正认为该master已经不可用了。mymaster为自定义的集群名字。(slave中写的是master的ip，master写自己ip)
sentinel monitor mymaster 192.168.1.152 6379 2

##若master配置了密码，则需要定义下面配置。在所有节点中都必须设置，避免重新选主后出现问题。
sentinel auth-pass mymaster 123123

##单位毫秒 3000毫秒没响应，认为主观下线
sentinel down-after-milliseconds mymaster 30000

##定义acl日志有多少条，acl日志存储在内存中，acl日志里记录跟acl相关的失败命令和身份验证事件
acllog-max-len 128

## 当替换主节点后，剩余从节点重新和新master做同步的并行数量，默认为 1
sentinel parallel-syncs mymaster 1

##若sentinel在该配置值(单位毫秒)内未能完成failover(故障转移)操作（即故障时master/slave自动切换），则认为本次failover失败。
sentinel failover-timeout mymaster 180000

## 在sentinel运行期间，不允许通过sentinel set命令重新配置notification-script（告警脚本）和client-reconfig-script（通知客户端，master已经更改成什么ip和port的脚本）
sentinel deny-scripts-reconfig yes

## 是否支持解析主机名
SENTINEL resolve-hostnames no
## 是否保留公开主机名
SENTINEL announce-hostnames no

## 如果设置为0，则当sentinel从master收到一个LoADING响应时，不会做故障转移。单位为毫秒，如果设置为非零，则在该时间段内，sentinel接收到LOADING响应时不做故障转移。
SENTINEL master-reboot-down-after-period mymaster 0
```
```
# 推送sentinel配置文件到其他节点。
scp /usr/local/redis/conf/sentinel.conf root@192.168.1.156:/usr/local/redis/conf/ 
scp /usr/local/redis/conf/sentinel.conf root@192.168.1.136:/usr/local/redis/conf/

# 更改目录及其配置文件属主
chown -R redis:redis /usr/local/redis/conf
chown -R redis:redis /usr/local/redis/log
```
```
# 配置systemd服务启动脚本
vi /lib/systemd/system/redis-sentinel.service

[Unit]
Description=redis
After=network.target
[Service]
User=redis
Type=forking
TimeoutSec=0
PIDFile=/usr/local/redis/log/redis-sentinel.pid
ExecStart=/usr/local/redis/bin/redis-sentinel /usr/local/redis/conf/sentinel.conf
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true
[Install]
WantedBy=multi-user.target
```
```
# 推送systemd配置到其他节点
scp /lib/systemd/system/redis-sentinel.service root@192.168.1.156:/lib/systemd/system/
scp /lib/systemd/system/redis-sentinel.service root@192.168.1.136:/lib/systemd/system/

# 加载、启动服务
systemctl daemon-reload
systemctl start redis-sentinel.service
```

## 测试sentinel
在lwz2(192.168.1.156)上连接sentinel
```
# 连接sentinel
/usr/local/redis/bin/redis-cli -p 26379

# 查看sentinel信息
127.0.0.1:26379> info sentinel
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_tilt_since_seconds:-1
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=192.168.1.152:6379,slaves=2,sentinels=3
```
在lwz1(192.168.1.152)执行
```
# 关闭主redis
systemctl stop redis

# 查看sentinel断开后的日志
cat /usr/local/redis/log/redis-sentinel.log
```

再次查看lwz2中的sentinel信息
```
# 此时master已经自动更改
127.0.0.1:26379> info sentinel
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_tilt_since_seconds:-1
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=192.168.1.156:6379,slaves=2,sentinels=3
```
重新选主后，三台节点的`sentinel.conf`配置文件中会有新增内容
```
vim /usr/local/redis/conf/sentinel.conf

# Generated by CONFIG REWRITE
maxclients 4064
latency-tracking-info-percentiles 50 99 99.9
user default on nopass sanitize-payload ~* &* +@all
sentinel myid 781eae6ab95f0bb927a6970b05841630dc4bec9b
sentinel config-epoch mymaster 1
sentinel leader-epoch mymaster 1
sentinel current-epoch 1

sentinel known-replica mymaster 192.168.1.152 6379

sentinel known-replica mymaster 192.168.1.136 6379

sentinel known-sentinel mymaster 192.168.1.136 26379 2c831e2b7f044823582c8a768fc9b93d47c9a784

sentinel known-sentinel mymaster 192.168.1.156 26379 0bee4b5356e52ed4e2cb8401af15859b96868d81


## 如下参数也已经自动更改为当前master ip地址
sentinel monitor mymaster 192.168.1.156 6379 2
```