# 存储
存储持久化相关三个概念：
- PersistentVolume（PV）  
是对具体存储资源的描述，比如NFS、Ceph、GlusterFS等，通过PV可以访问到具体的存储资源；

+ PersistentVolumeClaim（PVC）  
Pod想要使用具体的存储资源需要对接到PVC，PVC里会定义好Pod希望使用存储的属性，通过PVC再去申请合适的存储资源（PV），匹配到合适的资源后PVC和PV会进行绑定，它们两者是一一对应的；

- StorageClass（SC）  
PV可以手动创建，也可以自动创建，当PV需求量非常大时，如果靠手动创建PV就非常麻烦了，SC可以实现自动创建PV，并且会将PVC和PV绑定。

SC会定义两部分内容：  
① pv的属性，比如存储类型、大小；  
② 创建该PV需要用到的存储插件（provisioner），这个provisioner是实现自动创建PV的关键。  

## API资源对象PV和PVC
### PV YAML示例：
```yaml
vim testpv.yaml

apiVersion: v1
kind: PersistentVolume
metadata:
  name: testpv

spec:
  storageClassName: test-storage
  accessModes:
  - ReadWriteOnce
  capacity:
    storage: 500Mi  ##提供500Mi空间
  hostPath:
    path: /tmp/testpv/      ##本地存储路径
```
说明：
- storageClassName：  定义存储类名称，PV和PVC中都会有该字段，目的是为了方便两者匹配绑定在一起
- accessModes：定义该pv的访问权限模式，有三种：
    - ReadWriteOnce：存储卷可读可写，但只能被一个节点上的 Pod 挂载;
    - ReadOnlyMany：存储卷只读不可写，可以被任意节点上的 Pod 多次挂载;
    - ReadWriteMany：存储卷可读可写，也可以被任意节点上的 Pod 多次挂载;
- capacity： 定义该存储大小。
- hostPath： 定义该存储访问路径，这里指的是本地的磁盘。

### PVC  YAML示例：
```yaml
vim testpvc.yaml

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: testpvc

spec:
  storageClassName: test-storage
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Mi  ##期望申请100Mi空间
```
```bash
# 应用pv和pvc的YAML
kubectl apply -f testpv.yaml -f testpvc.yaml

# 查看状态
kubectl get pv,pvc
```

### PV和PVC匹配规则
PV创建好后，会等待PVC与其进行绑定，PVC一旦找到合适的PV就会绑定。如果有多个PV时，PVC又是如何匹配PV的呢？它有如下一些规则：  
① 访问模式和存储类匹配：Kubernetes会筛选出访问模式（accessModes）和存储类（storageClassName）与PVC相匹配的PV。如果没有匹配的PV，PVC将保持未绑定状态。  
② 资源大小：在满足访问模式和存储类匹配的PV中，Kubernetes会选择资源大小大于或等于PVC请求大小的PV。  
③ 最佳匹配：在满足访问模式、存储类和资源大小的PV中，Kubernetes会选择资源大小最接近PVC请求大小的PV。如果有多个PV具有相同的资源大小，Kubernetes会选择其中一个进行绑定。  
④ 避免重复绑定：一个PV在任何时候只能被一个PVC绑定。一旦PV被绑定到一个PVC，它将不再可用于其他PVC。  

------------------

## 本地存储
本地存储类型的PV是Kubernetes中一种比较特殊的持久化存储，它允许将节点上的本地磁盘或目录用作PV。与其他PV类型（例如NFS、Ceph或云存储）不同，本地存储类型的PV直接使用节点上的存储资源，因此具有更低的延迟和更高的性能。

使用本地存储类型的PV时，需注意以下几个关键点：
- 节点特性：  
本地存储类型的PV与特定的节点绑定，因为它直接使用节点上的存储资源。这意味着当创建PV时，需要指定与之关联的节点。可以在PV的spec部分设置nodeAffinity来实现的。
    ```yaml
    nodeAffinity:  ##定义节点亲和性
        required:
        nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
            operator: In
            values:
            - node-name
    ```

- 数据持久性：  
由于本地存储类型的PV与特定节点关联，当该节点发生故障时，存储在PV中的数据可能无法访问。因此，在使用本地存储类型的PV时，请确保采取适当的数据备份策略，以防止节点故障导致的数据丢失。
- 调度限制：  
Pod使用本地存储类型的Persistent Volume Claim（PVC）时，Kubernetes会尝试将Pod调度到关联PV的节点上。如果节点上的资源不足以运行Pod，Pod将无法启动。因此，在使用本地存储类型的PV时，请确保关联的节点有足够的资源来运行Pod。
- 回收策略：  
当PVC被删除时，PV的回收策略将决定如何处理关联的本地存储。对于本地存储类型的PV，建议使用Retain或Delete回收策略。
    - Retain策略：表示保留存储和数据，以便手动清理和管理；
    - Delete策略：表示删除存储和数据。需要注意的是，Recycle策略并不适用于本地存储类型的PV。
    ```yaml
    persistentVolumeReclaimPolicy: Retain
    ```

完整示例：
```bash
# 首先，确保在每个要使用本地存储的节点上创建一个本地目录。例如，在节点上创建/mnt/local-storage目录
mkdir -p /mnt/local-storage

# 然后，创建一个PV资源配置文件，例如local-pv.yaml
vim local-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv
  labels:
    type: local
spec:
  storageClassName: local-storage
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  local:
    path: /mnt/local-storage
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname  #这是内置的节点标签，表示节点的主机名
          operator: In
          values:
          - k8s2  #只有k8s2这个主机节点才满足要求

# 应用PV资源配置文件
kubectl apply -f local-pv.yaml


# 再创建一个PVC资源配置文件，例如local-pvc.yaml
vim local-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-pvc
spec:
  storageClassName: local-storage
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi

# 应用PVC资源配置文件
kubectl apply -f local-pvc.yaml

# Kubernetes会自动将PVC与PV绑定。创建好的PVC可以在Pod中使用，将本地存储挂载到容器中。

# 最后，创建一个Pod资源配置文件，例如local-pod.yaml
vim local-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: local-pod
spec:
  containers:
  - name: local-container
    image: nginx:1.21.0
    volumeMounts:
    - name: local-storage
      mountPath: /data
  volumes:
  - name: local-storage
    persistentVolumeClaim:
      claimName: local-pvc

# 应用Pod资源配置文件
kubectl apply -f local-pod.yaml

# 检查Pod状态
kubectl get pods

# 现在，local-pod中的local-container已经挂载了本地存储。所有写入/data目录的数据都将持久化在本地存储中。
```

### 本地存储的回收策略
本地存储类型的PV的回收策略决定了当PVC被删除时，PV中的数据如何处理。Kubernetes提供了三种回收策略：Retain、Recycle和Delete。
- Retain：保留数据，需要手动清理和管理。
- Recycle：清除数据，但保留文件系统。
``` 