# 主从复制

## 传统复制搭建
需要两台服务器，一台作为master，一台作为slave。
- master：192.168.1.152
- slave：192.168.1.136

master：
```
# 修改my.cnf配置文件的server_id后重启服务
sudo vim my.cnf
server_id = 1

sudo systemctl restart mysqld

# 创建slave复制用户
mysql> CREATE USER 'repl'@'192.168.1.136' IDENTIFIED WITH mysql_native_password BY 'linyi';
# 授权
mysql> grant REPLICATION SLAVE  on *.* to 'repl'@'192.168.1.136';
# 刷新
mysql> flush privileges;

# 查询日志和位置信息，记录file和Position的值，用于slave同步
mysql> show master status;
```

slave：
```
# 修改my.cnf
sudo vim my.cnf
server_id = 2

sudo systemctl restart mysqld

# 配置连接master信息
mysql> CHANGE MASTER TO MASTER_HOST='192.168.1.152',MASTER_USER='repl',MASTER_PASSWORD='linyi',MASTER_LOG_FILE='file.000001',MASTER_LOG_POS=Position值;

# 启动slave同步
mysql> start slave;

# 查看slave同步状态
mysql> show slave status\G;
```

## GTID复制搭建
取消传统复制配置
```
# master执行
mysql> reset master;

# slave执行
mysql> stop slave;
mysql> reset slave all;
```

### 搭建

(192.168.1.152)master配置：
```
# 修改配置文件my.cnf，重启服务
sudo vim my.cnf

server_id = 1               # 设置server_id
gtid_mode = on              # 开启gtid
enforce_gtid_consistency=on # 开启gtid一致性
log_bin=mysql-bin           # 开启binlog
binlog_format=row           # 设置binlog格式为row
log-slave-updates=1         # 开启slave复制，关闭为0
skip-slave-start=1          # 关闭slave跟随mysql启动而启动

sudo systemctl restart mysqld

# 创建slave授权用户
mysql> CREATE USER 'repl'@'192.168.1.136' IDENTIFIED WITH mysql_native_password BY 'linyi';
mysql> GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.1.136';
mysql> flush privileges;
```

(192.168.1.136)slave配置：
```
# 修改配置文件my.cnf，重启服务
sudo vim my.cnf

server_id = 2                # 设置server_id，不能和master重复，且不能为0，一般设置为IP最后一段
gtid_mode = on
enforce_gtid_consistency=on     
log_bin=mysql-bin
binlog_format=row
log-slave-updates=1
skip-slave-start=1

sudo systemctl restart mysqld

# 配置主从复制
mysql> change master to master_host='192.168.1.152',master_user='repl',master_password='linyi',master_auto_position=1,master_connect_retry=10;
mysql> start slave;

# 查看主从复制状态
mysql> show slave status\G;
```
