# 访问控制

## deny_allow
Nginx的deny和allow指令是由ngx_http_access_module模块提供，Nginx安装默认内置了该模块。  

### 语法
`allow/deny address | CIDR | unix: | all`

它表示，允许/拒绝某个ip或者一个ip段访问.如果指定unix:,那将允许socket的访问。  
注意：unix在1.5.1中新加入的功能。

在nginx中，allow和deny的规则是按顺序执行的。

### 示例
```bash
# 拒绝所有请求
[root@lwz2 vhost]# cat linyi.com
server {
    listen 80;
    server_name www.linyi.com;
    index  index.html;

    location /
    {
    proxy_pass http://192.168.1.152:8080;
    proxy_set_header host $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    deny all;
    }
}

#deny配置前访问
[root@lwz1 vhost]# curl www.linyi.com/1.html
111
#deny配置后访问
[root@lwz1 vhost]# curl www.linyi.com/1.html
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>
```
```bash
# 允许某个ip
server {
    listen 80;
    server_name www.linyi.com;
    index  index.html;

    location /
    {
    proxy_pass http://192.168.1.152:8080;
    proxy_set_header host $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    allow 192.168.1.152;
    deny all;
    }
}
```
- 配置在location段中，则匹配到location时，才会执行allow和deny的规则。
- 配置在server段中，则整个server段都会执行allow和deny的规则。

## 基于$document_uri的访问控制
这就用到了变量document_uri，根据前面所学内容，该变量等价于uri，其实也等价于location匹配

### 示例
```bash
server
{
  listen 8080;
  server_name www.123.com;
  if ($document_uri ~ "/admin/")
  {
         return 403;
  }
  if ($document_uri = "/admin.jsp")
  {
         return 403;
  }
  if ($document_uri ~ "/data/|/img/.*\.php$")
  {
         return 403;
  }
  location /
  {
         echo "www.123.com:8080";
  }
}
```
### 验证
```bash
# 当请求的uri中包含/admin/时，直接返回403.(if结构中不支持使用allow和deny。)
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/admin1/123.pp
www.123.com:8080
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/123/admin/123.pp
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/admin/123.pp
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>

# 请求的uri为/admin.jsp时返回403状态码
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/admin.jsp
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/admin.php
www.123.com:8080

# 请求的uri包含data或者img目录，并且是php时，返回403状态码。
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/data/123/23.php
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/data1/img/123/23.php
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/data1/img1/123/23.html
www.123.com:8080
```

## 基于$request_uri访问控制
request_uri比docuemnt_uri多了请求的参数。  
主要是针对请求的uri中的参数进行控制。  

### 示例
```bash
[root@rocky vhosts]# cat 123.com.conf
server
{
  listen 8080;
  server_name www.123.com;
  if ($request_uri ~ "gid=\d{9,12}")
  {
         return 403;
  }
  if ($request_uri ~ "xid=\D{1,2}")
  {
         return 403;
  }
  location / {
         echo "www.123.com";
  }
}
```
说明：\d{9,12}是正则表达式，表示9到12个数字，例如gid=1234567890就符号要求，\D非数字。

### 验证
```bash
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/123?gid=1234567890 -I
HTTP/1.1 403 Forbidden
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 09:59:37 GMT
Content-Type: text/html
Content-Length: 153
Connection: keep-alive

[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/123?gid=123A4567890 -I
HTTP/1.1 200 OK
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 09:59:40 GMT
Content-Type: application/octet-stream
Connection: keep-alive

[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/123?gid=123 -I
HTTP/1.1 200 OK
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 09:59:46 GMT
Content-Type: application/octet-stream
Connection: keep-alive

[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/123?xid=123 -I
HTTP/1.1 200 OK
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 09:59:59 GMT
Content-Type: application/octet-stream
Connection: keep-alive

[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com/123?xid=ab2 -I
HTTP/1.1 403 Forbidden
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 10:00:04 GMT
Content-Type: text/html
Content-Length: 153
Connection: keep-alive
```

## Nginx基于$user_agent的访问控制
user_agent大家并不陌生，可以简单理解成浏览器标识，包括一些蜘蛛爬虫都可以通过user_agent来辨识。  
通过观察访问日志，可以发现一些搜索引擎的蜘蛛对网站访问特别频繁，它们并不友好。  
为了减少服务器的压力，其实可以把除主流搜索引擎蜘蛛外的其他蜘蛛爬虫全部封掉。  
另外，一些cc攻击，我们也可以通过观察它们的user_agent找到规律。  

### 示例
```bash
server
{
  listen 8080;
  server_name www.123.com;
  if ($http_user_agent ~ 'curl|baidu')
  {
         return 403;
  }
  location / {
         echo "www.123.com";
  }
}
```

### 验证
```bash
[root@rocky vhosts]# curl -x127.0.0.1:8080 www.123.com -I
HTTP/1.1 403 Forbidden
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 10:10:04 GMT
Content-Type: text/html
Content-Length: 153
Connection: keep-alive

[root@rocky vhosts]# curl -x127.0.0.1:8080 -A "WINDOWS" www.123.com -I
HTTP/1.1 200 OK
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 10:10:16 GMT
Content-Type: application/octet-stream
Connection: keep-alive

[root@rocky vhosts]# curl -x127.0.0.1:8080 -A "baidu" www.123.com -I
HTTP/1.1 403 Forbidden
Server: nginx/1.23.1
Date: Thu, 25 Aug 2022 10:10:22 GMT
Content-Type: text/html
Content-Length: 153
Connection: keep-alive
```

## 基于$http_referer的访问控制
在前面讲解rewrite时，曾经用过该变量，当时实现了防盗链功能。  
其实基于该变量，我们也可以做一些特殊的需求。  

### 示例
背景：网站被黑挂马，搜索引擎收录的网页是有问题的，当通过搜索引擎点击到网站时，却显示一个博彩网站。  
由于查找木马需要时间，不能马上解决，为了不影响用户体验，可以针对此类请求做一个特殊操作。  
比如，可以把从百度访问的链接直接返回404状态码，或者返回一段html代码。  
```bash
server
{
  listen 8080;
  server_name www.123.com;
  if ($http_referer ~* 'baidu')
  {
         return 405;
  }
  location / {
         echo "www.123.com";
  }
}
```

### 验证
```bash
[root@rocky vhosts]# curl -x127.0.0.1:8080 -e "www.bai1du.com" www.123.com
www.123.com
[root@rocky vhosts]# curl -x127.0.0.1:8080 -e "www.Baidu.com" www.123.com
<html>
<head><title>405 Not Allowed</title></head>
<body>
<center><h1>405 Not Allowed</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>
```
