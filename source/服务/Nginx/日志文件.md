# 日志文件

## 错误日志

```
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
```
> - 格式：error_log  文件路径  日志级别；  
> - 源码安装默认文件路径：`/usr/local/nginx/logs/error.log`；yum安装默认路径：`/var/log/nginx/error.log`；
> - 日志级别不指定默认为：error； 
> - 错误日志的日志级别格式是固定的，不能自定义；  
> - 可以配置在main、http、server、location段里；  

日志级别：
- `debug`：最详细的日志级别，用于调试目的。记录有关每个请求的所有细节，包括请求头、响应头和其他调试信息。在生产环境中通常不使用这个级别，因为会产生大量日志数据。
    - debug模式需要在源码编译nginx时开启`--with-debug`参数后才能调用。
- `info`：记录关键事件和状态变化，通常用于生产环境中。这个级别下的日志包含 HTTP 请求处理的概要信息，例如请求的处理时间、状态码等。
- `notice`：用于记录一般性的重要信息。通常记录系统运行状态、配置错误、非致命错误等信息。
- `warn`：记录警告信息，表示可能会发生问题的事件。例如，磁盘空间不足、某些请求被拒绝等情况。
- `error`：记录错误事件，在这个级别下的日志会包含出现错误的请求、客户端断开连接、服务器错误等重要错误信息。
- `crit`：记录紧急情况，例如服务不可用、内部错误等。这些日志通常是需要立即关注和处理的。
- `alert`：记录需要立即处理的严重错误，通常需要立即通知系统管理员进行处理。
- `emerg`：最高级别的日志，用于紧急情况，表示系统已经不可用或正在发生严重错误，需要立即采取行动。


## 访问日志
可将下列内容配置在main、http、server、location段里：
```
#access_log  logs/access.log  main;
```
> - 格式：access_log  文件路径   格式名称；
> - 访问日志可以自定义格式，调用时在路径后面加上格式名称即可；
> - 若不配置log_format或者不在access_log配置中指定log_format;
  
日志格式定义：
```
$ vim /usr/local/nginx/conf/nginx.conf

# 默认格式
    '$remote_addr - $remote_user [$time_local] "$request" '
    '$status $body_bytes_sent "$http_referer" '
    '"$http_user_agent";

# combined_realip
log_format combined_realip '$remote_addr $http_x_forwarded_for [$time_local]'
    '$host "$request_uri" $status'
    '"$http_referer" "$http_user_agent"';

# main
log_format main '$remote_addr [$time_local] '
    '$host "$request_uri" $status "$request"'
    '"$http_referer" "$http_user_agent" "$request_time"';
```
> - 默认格式：适合用于记录通用的访问日志，可以满足大多数场景的需求。
> - `combined_realip`：类似于第一个格式，但在记录客户端 IP 地址时考虑了代理服务器的影响。客户端 IP 和代理 IP 都被记录，适合用于跟踪来自代理服务器的请求。这种格式适合用于记录通过代理服务器的请求，以及需要记录代理 IP 地址的情况。
> - `main`：这个格式与前两种格式相比，增加了 `$request_time`，记录了请求处理的时间。这种格式适合用于需要记录请求处理时间的场景，可以帮助分析请求的处理效率和性能。

变量说明：
- `$remote_addr`：客户端（用户）IP地址
- `$status`：请求状态码，如200，404，301，302等
- `$request`：请求方式（GET或者POST等）+URL（包含$request_method,$host,$request_uri）
- `$http_user_agent`：用户浏览器标识
- `$http_host`：请求的url地址（目标url地址）的host
- `$host`：等同于$http_host
- `$http_referer`：来源页面，即从哪个页面转到本页，如果直接在浏览器输入网址来访问，则referer为空
- `$uri`：请求中的当前URI(不带请求参数，参数位于args)，不同于浏览器传递的request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。
- `$document_uri`：等同于$uri
- `$request_uri`：比uri多了参数，即uri+$args
- `$http_x_forwarded_for`：如果使用了代理，这个参数会记录代理服务器的ip和客户端的ip

## 日志切割
使用[logrotate日志分割](https://linyi.readthedocs.io/zh/latest/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97/logrotate%E6%97%A5%E5%BF%97%E5%88%86%E5%89%B2.html)工具。

1. 创建文件
    ```
    $ vim /etc/logrotate.d/nginx

    /usr/local/nginx/logs/error.log {
        daily
        rotate 30
        missingok
        notifempty
        compress
        sharedscripts
        postrotate
            /bin/kill -USR1 $(cat /usr/local/nginx/logs/nginx.pid 2>/dev/null) 2>/dev/null
        endscript
    }
    ```
2. 执行命令分割
    ```
    logrotate -f /etc/logrotate.d/nginx
    ```
3. 效果
    ```
    [root@lwz vhosts]# ll /usr/local/nginx/logs/
    总用量 12
    -rw-r--r-- 1 nobody root 428 1月  12 17:51 access.log
    -rw-r--r-- 1 nobody root   0 1月  13 15:39 error.log
    -rw-r--r-- 1 root   root 282 1月  12 17:51 error.log.1.gz
    ```